// ==UserScript==
// @name         Blue Marble
// @namespace   https://github.com/twojapiez/
// @version      10.78.18
// @description  remove yap
// @author       SwingTheVine
// @license      MPL-2.0
// @icon         https://raw.githubusercontent.com/KeksTM/Wplace-BlueMarble-Auto-Fill/refs/heads/main/dist/assets/Favicon.png
// @updateURL    https://github.com/twojapiez/Wplace-BlueMarble-Auto-Fill/raw/refs/heads/main/dist/BlueMarble.user.js
// @downloadURL  https://github.com/twojapiez/Wplace-BlueMarble-Auto-Fill/raw/refs/heads/main/dist/BlueMarble.user.js
// @run-at       document-start
// @match        https://*.wplace.live/*
// @connect      *
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @resource     CSS-BM-File https://github.com/twojapiez/Wplace-BlueMarble-Auto-Fill/raw/refs/heads/main/dist/BlueMarble.user.css
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var t,e,n=t=>{throw TypeError(t)},i=(t,e,i)=>e.has(t)?n("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),o=(t,e,i)=>(((t,e)=>{e.has(t)||n("Cannot access private method")})(t,e),i),s=class{constructor(e,n){i(this,t),this.name=e,this.version=n,this.i=null,this.o="bm-b",this.l=null,this.h=null,this.u=[]}m(t){this.i=t}p(){return this.u.length>0&&(this.h=this.u.pop()),this}$(t){t?.appendChild(this.l),this.l=null,this.h=null,this.u=[]}T(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"div",{},n)),this}L(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"p",{},n)),this}I(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"small",{},n)),this}O(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"img",{},n)),this}v(n,i={},s=()=>{}){return s(this,o(this,t,e).call(this,"h"+n,{},i)),this}A(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"hr",{},n)),this}M(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"br",{},n)),this}F(n={},i=()=>{}){const s=o(this,t,e).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const a=o(this,t,e).call(this,"input",{type:"checkbox"},n);return s.insertBefore(a,s.firstChild),this.p(),i(this,s,a),this}C(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"button",{},n)),this}U(n={},i=()=>{}){const s=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${s}`;const a={textContent:"?",className:"bm-q",onclick:()=>{this.k(this.o,s)}};return i(this,o(this,t,e).call(this,"button",a,n)),this}P(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"input",{},n)),this}S(n={},i=()=>{}){const s=n.textContent??"";delete n.textContent;const a=o(this,t,e).call(this,"div"),c=o(this,t,e).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.p();const r=o(this,t,e).call(this,"button",{textContent:s});return this.p(),this.p(),c.setAttribute("tabindex","-1"),c.setAttribute("aria-hidden","true"),r.addEventListener("click",()=>{c.click()}),c.addEventListener("change",()=>{r.style.maxWidth=`${r.offsetWidth}px`,c.files.length>0?r.textContent=c.files[0].name:r.textContent=s}),i(this,a,c,r),this}D(n={},i=()=>{}){return i(this,o(this,t,e).call(this,"textarea",{},n)),this}k(t,e,n=!1){const i=document.getElementById(t.replace(/^#/,""));i&&(i instanceof HTMLInputElement?i.value=e:n?i.textContent=e:i.innerHTML=e)}N(t,e){let n,i=!1,o=0,s=null,a=0,c=0,r=0,l=0;if(t=document.querySelector("#"==t?.[0]?t:"#"+t),e=document.querySelector("#"==e?.[0]?e:"#"+e),!t||!e)return void this.R(`Can not drag! ${t?"":"moveMe"} ${t||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const h=()=>{if(i){const e=Math.abs(a-r),n=Math.abs(c-l);(e>.5||n>.5)&&(a=r,c=l,t.style.transform=`translate(${a}px, ${c}px)`,t.style.left="0px",t.style.top="0px",t.style.right=""),s=requestAnimationFrame(h)}};let d=null;const u=(u,m)=>{i=!0,d=t.getBoundingClientRect(),n=u-d.left,o=m-d.top;const p=window.getComputedStyle(t).transform;if(p&&"none"!==p){const t=new DOMMatrix(p);a=t.m41,c=t.m42}else a=d.left,c=d.top;r=a,l=c,document.body.style.userSelect="none",e.classList.add("dragging"),s&&cancelAnimationFrame(s),h()},m=()=>{i=!1,s&&(cancelAnimationFrame(s),s=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(t){t.preventDefault(),u(t.clientX,t.clientY)}),e.addEventListener("touchstart",function(t){const e=t?.touches?.[0];e&&(u(e.clientX,e.clientY),t.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(t){i&&d&&(r=t.clientX-n,l=t.clientY-o)},{passive:!0}),document.addEventListener("touchmove",function(t){if(i&&d){const e=t?.touches?.[0];if(!e)return;r=e.clientX-n,l=e.clientY-o,t.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",m),document.addEventListener("touchend",m),document.addEventListener("touchcancel",m)}W(t){(0,console.info)(`${this.name}: ${t}`),this.k(this.o,"Status: "+t,!0)}R(t){(0,console.error)(`${this.name}: ${t}`),this.k(this.o,"Error: "+t,!0)}};function a(t,e){if(0===t)return e[0];let n="";const i=e.length;for(;t>0;)n=e[t%i]+n,t=Math.floor(t/i);return n}function c(t){let e="";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function r(t){const e=atob(t),n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}t=new WeakSet,e=function(t,e={},n={}){const i=document.createElement(t);this.l?(this.h?.appendChild(i),this.u.push(this.h),this.h=i):(this.l=i,this.h=i);for(const[t,n]of Object.entries(e))i[t]=n;for(const[t,e]of Object.entries(n))i[t]=e;return i};var l,h,d,u=class{constructor({displayName:t="My template",B:e=0,_:n="",url:i="",file:o=null,coords:s=null,G:a=null,X:c=1e3}={}){this.displayName=t,this.B=e,this._=n,this.url=i,this.file=o,this.coords=s,this.G=a,this.X=c,this.Y=0}async H(){console.log("Template coordinates:",this.coords);const t=await createImageBitmap(this.file),e=t.width,n=t.height,i=e*n;console.log(`Template pixel analysis - Dimensions: ${e}×${n} = ${i.toLocaleString()} pixels`),this.Y=i;const o={},s={},a=new OffscreenCanvas(this.X,this.X),r=a.getContext("2d",{j:!0});for(let i=this.coords[3];i<n+this.coords[3];){const l=Math.min(this.X-i%this.X,n-(i-this.coords[3]));console.log(`Math.min(${this.X} - (${i} % ${this.X}), ${n} - (${i-this.coords[3]}))`);for(let n=this.coords[2];n<e+this.coords[2];){console.log(`Pixel X: ${n}\nPixel Y: ${i}`);const h=Math.min(this.X-n%this.X,e-(n-this.coords[2]));console.log(`Math.min(${this.X} - (${n} % ${this.X}), ${e} - (${n-this.coords[2]}))`),console.log(`Draw Size X: ${h}\nDraw Size Y: ${l}`);const d=3*h,u=3*l;a.width=d,a.height=u,console.log(`Draw X: ${h}\nDraw Y: ${l}\nCanvas Width: ${d}\nCanvas Height: ${u}`),r.imageSmoothingEnabled=!1,console.log(`Getting X ${n}-${n+h}\nGetting Y ${i}-${i+l}`),r.clearRect(0,0,d,u),r.drawImage(t,n-this.coords[2],i-this.coords[3],h,l,0,0,3*h,3*l);const m=r.getImageData(0,0,d,u);for(let t=0;t<u;t++)for(let e=0;e<d;e++)if(e%3!=1||t%3!=1){const n=4*(t*d+e);m.data[n+3]=0}console.log(`Shreaded pixels for ${n}, ${i}`,m),r.putImageData(m,0,0);const p=`${(this.coords[0]+Math.floor(n/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(i/1e3)).toString().padStart(4,"0")},${(n%1e3).toString().padStart(3,"0")},${(i%1e3).toString().padStart(3,"0")}`;o[p]=await createImageBitmap(a);const b=await a.convertToBlob(),f=await b.arrayBuffer(),g=Array.from(new Uint8Array(f));s[p]=c(g),console.log(o),n+=h}i+=l}return console.log("Template Tiles: ",o),console.log("Template Tiles Buffers: ",s),{J:o,q:s}}};l=new WeakSet,h=async function(){GM.setValue("bmTemplates",JSON.stringify(this.V))},d=async function(t){console.log("Parsing BlueMarble...");const e=t.templates;if(console.log(`BlueMarble length: ${Object.keys(e).length}`),Object.keys(e).length>0)for(const t in e){const n=t,i=e[t];if(console.log(n),e.hasOwnProperty(t)){const t=n.split(" "),e=Number(t?.[0]),o=t?.[1]||"0",s=i.name||`Template ${e||""}`,a=i.tiles,c={};for(const t in a)if(console.log(t),a.hasOwnProperty(t)){const e=r(a[t]),n=new Blob([e],{type:"image/png"}),i=await createImageBitmap(n);c[t]=i}const l=new u({displayName:s,B:e||this.K?.length||0,_:o||""});l.G=c,this.K.push(l),console.log(this.K),console.log("^^^ This ^^^")}}};var m=GM_info.script.name.toString(),p=GM_info.script.version.toString();!function(t){const e=document.createElement("script");e.setAttribute("bm-r",m),e.setAttribute("bm-o","color: cornflowerblue;"),e.textContent=`(${t})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const t=document.currentScript,e=t?.getAttribute("bm-r")||"Blue Marble",n=t?.getAttribute("bm-o")||"",i=new Map;window.addEventListener("message",t=>{const{source:o,endpoint:s,blobID:a,blobData:c,blink:r}=t.data,l=Date.now()-r;if(console.groupCollapsed(`%c${e}%c: ${i.size} Recieved IMAGE message about blob "${a}"`,n,""),console.log(`Blob fetch took %c${String(Math.floor(l/6e4)).padStart(2,"0")}:${String(Math.floor(l/1e3)%60).padStart(2,"0")}.${String(l%1e3).padStart(3,"0")}%c MM:SS.mmm`,n,""),console.log(i),console.groupEnd(),"blue-marble"==o&&a&&c&&!s){const t=i.get(a);"function"==typeof t?t(c):function(...t){(0,console.warn)(...t)}(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",a),i.delete(a)}});const o=window.fetch;window.fetch=async function(...t){const s=(t[0]instanceof Request?t[0]?.url:t[0])||"ignore",a=(t[1],await o.apply(this,t)),c=a.clone(),r=s,l=c.headers.get("content-type")||"";if(l.includes("application/json"))console.log(`%c${e}%c: Sending JSON message about endpoint "${r}"`,n,""),c.json().then(t=>{window.postMessage({source:"blue-marble",endpoint:r,jsonData:t},"*")}).catch(t=>{console.error(`%c${e}%c: Failed to parse JSON: `,n,"",t)});else if(l.includes("image/")&&!r.includes("openfreemap")&&!r.includes("maps")){const t=Date.now(),o=await c.blob();return console.log(`%c${e}%c: ${i.size} Sending IMAGE message about endpoint "${r}"`,n,""),new Promise(s=>{const a=crypto.randomUUID();i.set(a,t=>{s(new Response(t,{headers:c.headers,status:c.status,statusText:c.statusText})),console.log(`%c${e}%c: ${i.size} Processed blob "${a}"`,n,"")}),window.postMessage({source:"blue-marble",endpoint:r,blobID:a,blobData:o,blink:t})}).catch(o=>{const s=Date.now();console.error(`%c${e}%c: Failed to Promise blob!`,n,""),console.groupCollapsed(`%c${e}%c: Details of failed blob Promise:`,n,""),console.log(`Endpoint: ${r}\nThere are ${i.size} blobs processing...\nBlink: ${t.toLocaleString()}\nTime Since Blink: ${String(Math.floor(s/6e4)).padStart(2,"0")}:${String(Math.floor(s/1e3)%60).padStart(2,"0")}.${String(s%1e3).padStart(3,"0")} MM:SS.mmm`),console.error("Exception stack:",o),console.groupEnd()})}return a}});var b=GM_getResourceText("CSS-BM-File");GM_addStyle(b);var f=document.createElement("link");f.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",f.rel="preload",f.as="style",f.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(f),new class{constructor(){this.Z=null,this.tt=null,this.et="#bm-5"}nt(t){return this.tt=t,this.Z=new MutationObserver(t=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.matches?.(this.et)}),this}it(){return this.Z}observe(t,e=!1,n=!1){t.observe(this.tt,{childList:e,subtree:n})}};var g=new s(m,p),w=(new s(m,p),new class{constructor(t,e,n){i(this,l),this.name=t,this.version=e,this.l=n,this.ot="1.0.0",this.st=null,this.ct="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.X=1e3,this.rt=3,this.lt=null,this.ht=null,this.dt="bm-p",this.ut="div#map canvas.maplibregl-canvas",this.bt=null,this.ft="",this.K=[],this.V=null,this.gt=!0}wt(){if(document.body.contains(this.lt))return this.lt;document.getElementById(this.dt)?.remove();const t=document.querySelector(this.ut),e=document.createElement("canvas");return e.id=this.dt,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=t?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=t?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=t?.clientHeight*(window.devicePixelRatio||1),e.width=t?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",t?.parentElement?.appendChild(e),this.lt=e,window.addEventListener("move",this.$t),window.addEventListener("zoom",this.yt),window.addEventListener("resize",this.xt),this.lt}async Tt(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.ot,templates:{}}}async Lt(t,e,n){this.V||(this.V=await this.Tt(),console.log("Creating JSON...")),this.l.W(`Creating template at ${n.join(", ")}...`);const i=new u({displayName:e,B:0,_:a(this.st||0,this.ct),file:t,coords:n}),{J:s,q:c}=await i.H(this.X);i.G=s,this.V.templates[`${i.B} ${i._}`]={name:i.displayName,coords:n.join(", "),enabled:!0,tiles:c},this.K=[],this.K.push(i);const r=(new Intl.NumberFormat).format(i.Y);this.l.W(`Template created at ${n.join(", ")}! Total pixels: ${r}`),console.log(Object.keys(this.V.templates).length),console.log(this.V),console.log(this.K),console.log(JSON.stringify(this.V)),await o(this,l,h).call(this)}It(){}async Ot(){this.V||(this.V=await this.Tt(),console.log("Creating JSON..."))}async vt(t,e){if(!this.gt)return t;const n=this.X*this.rt;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"),console.log(`Searching for templates in tile: "${e}"`);const i=this.K;console.log(i),i.sort((t,e)=>t.B-e.B),console.log(i);const o=i.map(t=>{const n=Object.keys(t.G).filter(t=>t.startsWith(e));if(0===n.length)return null;const i=n.map(e=>{const n=e.split(",");return{At:t.G[e],Mt:[n[0],n[1]],Ft:[n[2],n[3]]}});return i?.[0]}).filter(Boolean);console.log(o);const s=o?.length||0;if(console.log(`templateCount = ${s}`),s>0){const t=i.filter(t=>Object.keys(t.G).filter(t=>t.startsWith(e)).length>0).reduce((t,e)=>t+(e.Y||0),0),n=(new Intl.NumberFormat).format(t);this.l.W(`Displaying ${s} template${1==s?"":"s"}.\nTotal pixels: ${n}`)}else this.l.W(`Displaying ${s} templates.`);const a=await createImageBitmap(t),c=new OffscreenCanvas(n,n),r=c.getContext("2d");r.imageSmoothingEnabled=!1,r.beginPath(),r.rect(0,0,n,n),r.clip(),r.clearRect(0,0,n,n),r.drawImage(a,0,0,n,n);for(const t of o)console.log("Template:"),console.log(t),r.drawImage(t.At,Number(t.Ft[0])*this.rt,Number(t.Ft[1])*this.rt);return await c.convertToBlob({type:"image/png"})}Ct(t){console.log("Importing JSON..."),console.log(t),"BlueMarble"==t?.whoami&&o(this,l,d).call(this,t)}Ut(t){this.gt=t}}(m,p,g)),$=new class{constructor(t){this.kt=t,this.Pt=!1,this.St=[],this.Dt=[],this.droplets=0,this.charges=null,this.extraColorsBitmap=null,this.flagsBitmap=null}async Nt(){try{const t=await fetch("https://backend.wplace.live/me",{credentials:"include"});if(t.ok){const e=await t.json();return console.log("ApiManager: Fetched fresh user data:",e),void 0!==e.extraColorsBitmap&&(this.extraColorsBitmap=e.extraColorsBitmap),void 0!==e.flagsBitmap&&(this.flagsBitmap=e.flagsBitmap),void 0!==e.droplets&&(this.droplets=e.droplets),void 0!==e.charges&&(this.charges=e.charges),void 0!==e.id&&(this.kt.st=e.id),e}return console.warn("ApiManager: Failed to fetch user data:",t.status),null}catch(t){return console.error("ApiManager: Error fetching user data:",t),null}}Et(t){window.addEventListener("message",async e=>{const n=e.data,i=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const o=n.endpoint?.split("?")[0].split("/").filter(t=>t&&isNaN(Number(t))).filter(t=>t&&!t.includes(".")).pop();switch(console.log('%cBlue Marble%c: Recieved message about "%s"',"color: cornflowerblue;","",o),o){case"me":if(i.status&&"2"!=i.status?.toString()[0])return void t.R("You are not logged in!\nCould not fetch userdata.");const e=Math.ceil(Math.pow(Math.floor(i.level)*Math.pow(30,.65),1/.65)-i.pixelsPainted);console.log(i.id),(i.id||0===i.id)&&console.log(a(i.id,"!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~")),this.kt.st=i.id,this.droplets=i.droplets,this.charges=i.charges,this.extraColorsBitmap=i.extraColorsBitmap,this.flagsBitmap=i.flagsBitmap,t.k("bm-h",`Username: <b>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(i.name)}</b>`),t.k("bm-c",`Droplets: <b>${(new Intl.NumberFormat).format(i.droplets)}</b>`),t.k("bm-6",`Next level in <b>${(new Intl.NumberFormat).format(e)}</b> pixel${1==e?"":"s"}`);break;case"pixel":const o=n.endpoint.split("?")[0].split("/").filter(t=>t&&!isNaN(Number(t))),r=new URLSearchParams(n.endpoint.split("?")[1]),l=[r.get("x"),r.get("y")];if(this.St.length&&(!o.length||!l.length))return void t.R("Coordinates are malformed!\nDid you try clicking the canvas first?");this.St=[...o,...l];const h=(s=o,c=l,[parseInt(s[0])%4*1e3+parseInt(c[0]),parseInt(s[1])%4*1e3+parseInt(c[1])]),d=document.querySelectorAll("span");for(const t of d)if(t.textContent.trim().includes(`${h[0]}, ${h[1]}`)){let e=document.querySelector("#bm-5");const n=`(Tl X: ${o[0]}, Tl Y: ${o[1]}, Px X: ${l[0]}, Px Y: ${l[1]})`;e?e.textContent=n:(e=document.createElement("span"),e.id="bm-5",e.textContent=n,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",t.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e))}break;case"tiles":let u=n.endpoint.split("/");u=[parseInt(u[u.length-2]),parseInt(u[u.length-1].replace(".png",""))];const m=n.blobID,p=n.blobData,b=await this.kt.vt(p,u);window.postMessage({source:"blue-marble",blobID:m,blobData:b,blink:n.blink});break;case"robots":this.Pt="false"==i.userscript?.toString().toLowerCase();break}var s,c})}}(w);g.m($);var y=JSON.parse(GM_getValue("bmTemplates","{}"));console.log(y),w.Ct(y),function(){let t=!1;g.T({id:"bm-n",style:"top: 10px; left: 50px;"}).T({id:"bm-7"}).T({id:"bm-i"}).p().O({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(e,n)=>{n.addEventListener("click",()=>{t=!t;const i=document.querySelector("#bm-n"),o=document.querySelector("#bm-7"),s=document.querySelector("#bm-i"),a=document.querySelector("#bm-8"),c=document.querySelector("#bm-d"),r=document.querySelector("#bm-e"),l=document.querySelector("#bm-f"),h=document.querySelector("#bm-9"),d=document.querySelectorAll("#bm-8 input");t||(i.style.width="auto",i.style.maxWidth="300px",i.style.minWidth="200px",i.style.padding="10px"),["#bm-n h1","#bm-4","#bm-n hr","#bm-3 > *:not(#bm-8)","#bm-u","#bm-D","#bm-2","#bm-1",`#${e.o}`,"#bm-L"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=t?"none":""})}),t?(a&&(a.style.display="none"),c&&(c.style.display="none"),r&&(r.style.display="none"),l&&(l.style.display="none"),h&&(h.style.display="none"),d.forEach(t=>{t.style.display="none"}),i.style.width="60px",i.style.height="76px",i.style.maxWidth="60px",i.style.minWidth="60px",i.style.padding="8px",n.style.marginLeft="3px",o.style.textAlign="center",o.style.margin="0",o.style.marginBottom="0",s&&(s.style.display="",s.style.marginBottom="0.25em")):(a&&(a.style.display="",a.style.flexDirection="",a.style.justifyContent="",a.style.alignItems="",a.style.gap="",a.style.textAlign="",a.style.margin=""),c&&(c.style.display=""),r&&(r.style.display="",r.style.marginTop=""),l&&(l.style.display="",l.style.marginTop=""),h&&(h.style.display="",h.style.marginTop=""),d.forEach(t=>{t.style.display=""}),n.style.marginLeft="",i.style.padding="10px",o.style.textAlign="",o.style.margin="",o.style.marginBottom="",s&&(s.style.marginBottom="0.5em"),i.style.width="",i.style.height=""),n.alt=t?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).p().v(1,{textContent:m}).p().p().A().p().T({id:"bm-4"}).L({id:"bm-h",textContent:"Username:"}).p().L({id:"bm-c",textContent:"Droplets:"}).p().L({id:"bm-6",textContent:"Next level in..."}).p().p().A().p().T({id:"bm-3"}).T({id:"bm-8"}).C({id:"bm-d",className:"bm-q",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(t,e)=>{e.onclick=()=>{const e=t.i?.St;e?.[0]?(t.k("bm-j",e?.[0]||""),t.k("bm-k",e?.[1]||""),t.k("bm-l",e?.[2]||""),t.k("bm-m",e?.[3]||"")):t.R("Coordinates are malformed! Did you try clicking on the canvas first?")}}).p().P({type:"number",id:"bm-j",placeholder:"Tl X",min:0,max:2047,step:1,required:!0}).p().P({type:"number",id:"bm-k",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0}).p().P({type:"number",id:"bm-l",placeholder:"Px X",min:0,max:2047,step:1,required:!0}).p().P({type:"number",id:"bm-m",placeholder:"Px Y",min:0,max:2047,step:1,required:!0}).p().T({id:"bm-u",style:"display: flex; align-items: center; gap: 0.5ch; margin-top: 0.5em;"}).L({textContent:"Protect Delay:",style:"margin: 0; white-space: nowrap;"}).p().T({id:"bm-I",style:"display: flex; align-items: center;"}).C({id:"bm-B",textContent:"-",style:"width: 24px; height: 24px; padding: 0; border-radius: 4px 0 0 4px; border: 1px solid #ccc; font-size: 16px; line-height: 1; margin: 0;"},(t,e)=>{e.onclick=()=>{const t=document.querySelector("#bm-y");let e=parseInt(t.value)||0;if(e>0){e--,t.value=e;const n=document.querySelector("#bm-Z");n&&(n.textContent=`(${30*e}s)`)}}}).p().P({type:"number",id:"bm-y",value:"0",min:"0",max:"60",step:"1",style:"width: 50px; text-align: center; border: 1px solid #ccc; border-left: 0; border-right: 0; border-radius: 0; margin: 0; height: 24px;"},(t,e)=>{e.oninput=()=>{let t=parseInt(e.value)||0;t<0&&(t=0,e.value=t),t>60&&(t=60,e.value=t);const n=document.querySelector("#bm-Z");n&&(n.textContent=`(${30*t}s)`)}}).p().C({id:"bm-C",textContent:"+",style:"width: 24px; height: 24px; padding: 0; border-radius: 0 4px 4px 0; border: 1px solid #ccc; font-size: 16px; line-height: 1; margin: 0;"},(t,e)=>{e.onclick=()=>{const t=document.querySelector("#bm-y");let e=parseInt(t.value)||0;if(e<60){e++,t.value=e;const n=document.querySelector("#bm-Z");n&&(n.textContent=`(${30*e}s)`)}}}).p().I({id:"bm-Z",textContent:"(0s)",style:"margin-left: 0.5ch;"}).p().p().p().T({id:"bm-D",style:"display: flex; align-items: center; gap: 0.5ch; margin-top: 0.5em;"}).L({textContent:"Charge Limit:",style:"margin: 0; white-space: nowrap;"}).p().T({id:"bm-v",style:"display: flex; align-items: center;"}).C({id:"bm-z",textContent:"−",style:"width: 24px; height: 24px; padding: 0; border-radius: 4px 0 0 4px; border: 1px solid #ccc; font-size: 16px; line-height: 1; margin: 0;"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-H"),n=document.querySelector("#bm-E");if(t.i?.charges?.max){const i=Math.floor(t.i.charges.max);parseInt(e.max)!==i&&(e.max=i,n&&(n.textContent=`/${i}`))}let i=parseInt(e.value)||1;i>1&&(i--,e.value=10)}}).p().P({type:"number",id:"bm-H",value:"10",min:"1",max:"10",step:"1",style:"width: 50px; text-align: center; border: 1px solid #ccc; border-left: 0; border-right: 0; border-radius: 0; margin: 0; height: 24px;"},(t,e)=>{const n=t.i?.charges;if(n&&n.max){e.max=n.max,e.value=10;const t=document.querySelector("#bm-E");t&&(t.textContent=`/${n.max}`)}e.oninput=()=>{const n=document.querySelector("#bm-E");if(t.i?.charges?.max){const i=Math.floor(t.i.charges.max);parseInt(e.max)!==i&&(e.max=i,n&&(n.textContent=`/${i}`))}let i=parseInt(e.value)||1;const o=parseInt(e.max)||10;i<1&&(i=1,e.value=i),i>o&&(i=o,e.value=i)}}).p().C({id:"bm-A",textContent:"+",style:"width: 24px; height: 24px; padding: 0; border-radius: 0 4px 4px 0; border: 1px solid #ccc; font-size: 16px; line-height: 1; margin: 0;"},(t,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-H"),n=document.querySelector("#bm-E");if(t.i?.charges?.max){const i=Math.floor(t.i.charges.max);parseInt(e.max)!==i&&(e.max=i,n&&(n.textContent=`/${i}`))}let i=parseInt(e.value)||1;i<(parseInt(e.max)||10)&&(i++,e.value=i)}}).p().I({id:"bm-E",textContent:"N/A",style:"margin-left: 0.5ch;"}).p().p().p().p().S({id:"bm-2",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"},(t,e)=>{e.addEventListener("change",e=>{const n=e.target.files[0];if(!n)return;const i=n.name;console.log(`AUTOFILL: Parsing filename for coordinates: ${i}`);const o=i.replace(/\.[^/.]+$/,"").match(/(\d{1,4})-(\d{1,4})-(\d{1,4})-(\d{1,4})/);if(o){const[,e,n,i,s]=o;console.log(`AUTOFILL: Found coordinates in filename: TlX=${e}, TlY=${n}, PxX=${i}, PxY=${s}`);const a=document.querySelector("#bm-j"),c=document.querySelector("#bm-k"),r=document.querySelector("#bm-l"),l=document.querySelector("#bm-m");a&&(a.value=e),c&&(c.value=n),r&&(r.value=i),l&&(l.value=s),t.W(`📍 Auto-populated coordinates from filename: (${e},${n}) to (${i},${s})`);const h=document.querySelector("#bm-e");h&&(console.log("AUTOFILL: Auto-clicking Create button after coordinate population"),setTimeout(()=>{h.click(),t.W("🚀 Auto-created template with coordinates from filename")},100))}else console.log(`AUTOFILL: No coordinate pattern found in filename: ${i}`)})}).p().T({id:"bm-0"}).C({id:"bm-f",textContent:"Enable"},(t,e)=>{e.onclick=()=>{t.i?.kt?.Ut(!0),t.W("Enabled templates!");const e=document.querySelector("#bm-M"),n=document.querySelector("#bm--"),i=document.querySelector("#bm-S");t.i?.kt?.K.length&&t.i?.kt?.gt&&(e&&(e.disabled=!1),n&&(n.disabled=!1),i&&(i.disabled=!1))}}).p().C({id:"bm-e",textContent:"Create"},(t,e)=>{e.onclick=async()=>{const e=document.querySelector("#bm-2"),n=document.querySelector("#bm-j");if(!n.checkValidity())return n.reportValidity(),void t.R("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-k");if(!i.checkValidity())return i.reportValidity(),void t.R("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-l");if(!o.checkValidity())return o.reportValidity(),void t.R("Coordinates are malformed! Did you try clicking on the canvas first?");const s=document.querySelector("#bm-m");if(!s.checkValidity())return s.reportValidity(),void t.R("Coordinates are malformed! Did you try clicking on the canvas first?");e?.files[0]?(await w.Lt(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(i.value),Number(o.value),Number(s.value)]),t.W("Drew to canvas!")):t.R("No file selected!")}}).p().C({id:"bm-9",textContent:"Disable"},(t,e)=>{e.onclick=()=>{t.i?.kt?.Ut(!1),t.W("Disabled templates!");const e=document.querySelector("#bm-M"),n=document.querySelector("#bm--"),i=document.querySelector("#bm-S");e&&(e.disabled=!0),n&&(n.disabled=!0),i&&(i.disabled=!0)}}).p().C({id:"bm-M",textContent:"Auto Fill",disabled:!0},(t,e)=>{class n{constructor(){this.Rt=0,this.Wt=3}async Bt(t,e=!1){const[n,i]=t,[o,s]=n;console.log(`AUTOFILL: Processing chunk ${o},${s} with ${i.length} pixels`),e?(console.log("AUTOFILL: Reopening paint menu for next chunk"),await this._t()):await this._t(),await this.Gt(n,i)}async _t(){const t=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",{zt:100,Xt:!0,Yt:200,Ht:"AUTOFILL"});if(!t.jt)throw new Error(`Could not find paint button: ${t.reason}`);t.element.click(),console.log("AUTOFILL: Paint menu opened")}async Gt(t,e){await u(t,e,0),console.log("AUTOFILL: Pixel placement completed"),e.forEach(([e,n])=>{t[0],t[1]})}}class i{constructor(t){this.i=t}Jt(t,e){const n=document.querySelector("#bm-H"),i=parseInt(n?.value||t.max);if(t.count>=i)return!1;const o=Math.floor(t.count),s=e>o;return console.log(`D_AUTOFILL: shouldWaitForCharges - pixelsNeeded: ${e}, currentCharges: ${o}, charges.count: ${t.count}, chargeLimit: ${i}, shouldWait: ${s}`),s}qt(t,e){const n=document.querySelector("#bm-H"),i=parseInt(n?.value||t.max),o=Math.floor(t.count),s=Math.min(e,i),a=s-o,c=t.count-Math.floor(t.count),r=t.Vt||3e4;if(console.log(`D_AUTOFILL: calculateWaitTime - pixelsNeeded: ${e}, targetCharges: ${s}, currentCharges: ${o}, chargesNeeded: ${a}, chargeLimit: ${i}`),a<=1){const t=Math.ceil((1-c)*r);return console.log(`D_AUTOFILL: calculateWaitTime - need ${a} more charges, waiting ${t}ms for current charge`),t}const l=Math.ceil((1-c)*r)+(a-1)*r;return console.log(`D_AUTOFILL: calculateWaitTime - need ${a} more charges, waiting ${l}ms total`),l}}const o=t=>new Promise(e=>setTimeout(e,t)),s=new Set,a={0:[0,0,0,0],1:[0,0,0,255],2:[60,60,60,255],3:[120,120,120,255],4:[210,210,210,255],5:[255,255,255,255],6:[96,0,24,255],7:[237,28,36,255],8:[255,127,39,255],9:[246,170,9,255],10:[249,221,59,255],11:[255,250,188,255],12:[14,185,104,255],13:[19,230,123,255],14:[135,255,94,255],15:[12,129,110,255],16:[16,174,166,255],17:[19,225,190,255],18:[40,80,158,255],19:[64,147,228,255],20:[96,247,242,255],21:[107,80,246,255],22:[153,177,251,255],23:[120,12,153,255],24:[170,56,185,255],25:[224,159,249,255],26:[203,0,122,255],27:[236,31,128,255],28:[243,141,169,255],29:[104,70,52,255],30:[149,104,42,255],31:[248,178,119,255],32:[170,170,170,255],33:[165,14,30,255],34:[250,128,114,255],35:[228,92,26,255],36:[214,181,148,255],37:[156,132,49,255],38:[197,173,49,255],39:[232,212,95,255],40:[74,107,58,255],41:[90,148,74,255],42:[132,197,115,255],43:[15,121,159,255],44:[187,250,242,255],45:[125,199,255,255],46:[77,49,184,255],47:[74,66,132,255],48:[122,113,196,255],49:[181,174,241,255],50:[219,164,99,255],51:[209,128,81,255],52:[255,197,165,255],53:[155,82,73,255],54:[209,128,120,255],55:[250,182,164,255],56:[123,99,82,255],57:[156,132,107,255],58:[51,57,65,255],59:[109,117,141,255],60:[179,185,209,255],61:[109,100,63,255],62:[148,140,107,255],63:[205,197,158,255]},c=t=>{const e=document.querySelector("#bm-L");if(e){const n=`[${(new Date).toLocaleTimeString()}] ${t}`;e.value=n+"\n";const i=e.value.split("\n");i.length>20&&(e.value=i.slice(0,20).join("\n")),e.scrollTop=0}},r=t=>{const e=document.querySelector("#bm-K"),n=30*t;if(e){let i=`Remaining Pixels: ${t.toLocaleString()}`;i+=null!==n&&n>0?`\nEstimated Time: ${(t=>{const e=Math.floor(t/3600),n=Math.floor(t%3600/60),i=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`})(n)}`:"\nEstimated Time: N/A",e.value=i}},l=async(t,e={})=>{const{zt:n=100,Xt:i=!1,Yt:s=200,Ht:a="AUTOFILL",description:r="element",Kt:l=""}=e;let h=document.querySelector(t),d=0;for(console.log(`${a}: Looking for ${r}${l}...`),c(`🔍 Looking for ${r}${l}...`);(!h||i&&h.disabled)&&d<n;){d++;const e=`${a}: Waiting for ${r} to be ready${l}... (${d}s/${n}s)`;console.log(e),c(`⏳ Waiting for ${r} to be ready${l}... (${d}s/${n}s)`),await o(s),h=document.querySelector(t)}return h?i&&h.disabled?(c(`❌ ${r} still disabled after waiting${l}`),console.error(`${a}: ${r} still disabled after waiting${l}`),{jt:!1,element:h,reason:"disabled"}):(c(`✅ ${r} is ready${l}`),console.log(`${a}: ${r} is ready${l}`),{jt:!0,element:h,reason:"ready"}):(c(`❌ ${r} not found after waiting${l}`),console.error(`${a}: ${r} not found after waiting${l}`),{jt:!1,element:null,reason:"not_found"})};function h(t){const e=new Set;for(let t=0;t<32;t++)e.add(t);if(t){t<0&&(t>>>=0);for(let n=0;n<32;n++)t&1<<n&&e.add(n+32)}return Array.from(e).sort((t,e)=>t-e)}const d=async(e,n=[])=>{const i={};if(!t.i?.kt?.K?.length)return[];const o=t.i.kt.K[0].G;if(!o)return t.R("Template has no pixel data (chunked property is missing)."),[];const c=new Set(n),r=new Map,l=(t,e,n,i)=>{if(0===i)return 0;if(222===t&&250===e&&206===n)return 0;const o=`${t},${e},${n}`;if(r.has(o))return r.get(o);let s=1/0,c=1;for(const[i,[o,r,l]]of Object.entries(a)){if("0"===i)continue;const a=(t-o)**2+(e-r)**2+(n-l)**2;a<s&&(s=a,c=parseInt(i))}return r.set(o,c),c},h=Object.keys(o).sort(),d=new Map,u=new Map,m=new Map;h.forEach(t=>{u.has(t)||u.set(t,t.split(",").map(Number))});const p=new Set,b=[];let f={Zt:1/0,Qt:-1/0,te:1/0,ee:-1/0};const g=new Set;for(const t of h){const e=u.get(t),[n,i]=e,o=`${n},${i}`;g.add(o)}const w=Array.from(g).map(async t=>{const e=await(async(t,e)=>{try{const n=await fetch(`https://backend.wplace.live/files/s0/tiles/${t}/${e}.png`);if(!n.ok)return console.log(`AUTOFILL: Chunk ${t},${e} not found or empty`),null;const i=await n.blob();return await createImageBitmap(i)}catch(n){return console.warn(`AUTOFILL: Failed to fetch chunk ${t},${e}:`,n),null}})(...t.split(",").map(Number));return{ne:t,ie:e}});(await Promise.all(w)).forEach(({ne:t,ie:e})=>{d.set(t,e)});const $=document.querySelector("#bm--"),y=$?$.textContent.replace("Mode: ",""):"Random",x="Scan"!==y,T=h.length,L=T>50,I=Math.min(3*e,1e4),O=L&&x&&e<1e3;let v=0;t:for(const t of h){const i=o[t];if(!i)continue;if(O&&(v++,v%Math.max(1,Math.floor(T/(I/100)))!==0&&b.length>e))continue;const a=u.get(t),[r,h,g,w]=a;console.log(`AUTOFILL: Processing tile - ChunkX: ${r}, ChunkY: ${h}, TileCoordX: ${g}, TileCoordY: ${w}`);const $=`${r},${h}`,y=d.get($);let L;if(m.has(t))L=m.get(t);else{const e=new OffscreenCanvas(i.width,i.height).getContext("2d");e.drawImage(i,0,0),L=e.getImageData(0,0,i.width,i.height),m.set(t,L)}let A=null;if(y){const t=`${$}_imagedata`;if(m.has(t))A=m.get(t);else{const e=new OffscreenCanvas(y.width,y.height).getContext("2d");e.drawImage(y,0,0),A=e.getImageData(0,0,y.width,y.height),m.set(t,A)}}const M=L.data,F=A?A.data:null,C=i.width,U=A?A.width:0,k=A?A.height:0;for(let t=1;t<i.height;t+=3){const o=t*C*4;for(let a=1;a<i.width;a+=3){const i=o+4*a,d=M[i+3];if(0===d)continue;const u=l(M[i],M[i+1],M[i+2],d),m=g+((a-1)/3|0),$=w+((t-1)/3|0),y=1e3*r+m,T=1e3*h+$;f.Zt=Math.min(f.Zt,y),f.Qt=Math.max(f.Qt,y),f.te=Math.min(f.te,T),f.ee=Math.max(f.ee,T);const L=`${r},${h},${m},${$}`;if(p.add(L),n.length>0&&!c.has(u))continue;let I=!0;if(F&&m>=0&&m<U&&$>=0&&$<k){const t=4*($*U+m);l(F[t],F[t+1],F[t+2],F[t+3])===u&&(I=!1)}if(I&&!s.has(L)&&(b.push({oe:r,se:h,ae:m,ce:$,re:u,le:L,he:y,de:T}),x&&b.length>=2*e)){console.log(`AUTOFILL: Early termination - found ${b.length} pixels (target: ${e})`);break t}}}}const A=t=>{const e=t.he,n=t.de;if(e===f.Zt||e===f.Qt||n===f.te||n===f.ee)return!0;const i=[[0,-1],[-1,0],[1,0],[0,1]];for(let t=0;t<4;t++){const o=e+i[t][0],s=n+i[t][1],a=o>=0?o/1e3|0:Math.floor(o/1e3),c=s>=0?s/1e3|0:Math.floor(s/1e3),r=a+","+c+","+(o-1e3*a)+","+(s-1e3*c);if(!p.has(r))return!0}const o=[[-1,-1],[1,-1],[-1,1],[1,1]];for(let t=0;t<4;t++){const i=e+o[t][0],s=n+o[t][1],a=i>=0?i/1e3|0:Math.floor(i/1e3),c=s>=0?s/1e3|0:Math.floor(s/1e3),r=a+","+c+","+(i-1e3*a)+","+(s-1e3*c);if(!p.has(r))return!0}return!1},M=[],F=[];for(const t of b)A(t)?M.push(t):F.push(t);let C=[];if("Scan"===y)C=[...M.sort((t,e)=>t.de!==e.de?t.de-e.de:t.he-e.he),...F.sort((t,e)=>t.de!==e.de?t.de-e.de:t.he-e.he)],console.log(`AUTOFILL: 📏 Scan mode: ${M.length} edge pixels first, then ${F.length} non-edge pixels (both in scanline order)`);else{const t=t=>{const e=[...t];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e};C=[...t(M),...t(F)],console.log(`AUTOFILL: 🎲 Random mode: ${M.length} edge pixels first (randomized), then ${F.length} inner pixels (randomized)`)}let U=0;for(const t of C){if(U>=e)break;const n=`${t.oe},${t.se}`;i[n]||(i[n]={ue:[t.oe,t.se],me:[]}),i[n].me.push([t.ae,t.ce,t.re]),U++}return console.log(`AUTOFILL: \n📊 SUMMARY: Found ${b.length} total pixels that need placement (filtered by ${n.length} owned colors), returning ${U} pixels (${M.length} edge priority)`),{pe:Object.values(i).map(t=>[t.ue,t.me]),be:b.length,fe:p.size}},u=async(t,e,n=0)=>{if(!e||0===e.length)return;const[i,s]=t,a=(t,n,o)=>({ge:{colors:e.map(([,,t])=>t),coords:e.flatMap(([t,e])=>[t,e]),t:n},we:`https://backend.wplace.live/s0/pixel/${i}/${s}`}),r=async()=>{const t=document.querySelector(".maplibregl-canvas");if(!t)throw new Error("Could not find the map canvas.");const e=window.innerWidth/2,n=window.innerHeight/2,i=["mousedown","click","mouseup"];for(const s of i){const i=new MouseEvent(s,{clientX:e,clientY:n,bubbles:!0});t.dispatchEvent(i),await o(50)}console.log("AUTOFILL: Starting...");const s=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative",{zt:100,Xt:!0,Yt:200,Ht:"AUTOFILL",description:"final pixel placement button",Kt:""});if(!s.jt){try{console.warn("AUTOFILL: Final paint button not found or disabled - attempting to close paint menu"),c("⚠️ Final paint button missing or disabled - trying to close paint menu...");const t=[".btn.btn-secondary",".modal-close",".close",'[aria-label="Close"]',".btn.btn-outline"];for(const e of t){const t=document.querySelector(e);if(t)try{t.click(),console.log(`AUTOFILL: Clicked close element (${e})`),await o(150);break}catch(t){}}try{const t=new KeyboardEvent("keydown",{key:"Escape",code:"Escape",bubbles:!0});document.dispatchEvent(t),console.log("AUTOFILL: Dispatched Escape key to close modal"),await o(150)}catch(t){}const e=document.querySelector(".maplibregl-canvas");if(e)try{e.click(),console.log("AUTOFILL: Clicked canvas to close any overlays"),await o(150)}catch(t){}}catch(t){console.warn("AUTOFILL: Error while attempting to close paint menu",t)}throw new Error(`Could not find or enable final paint button: ${s.reason}`)}console.log("AUTOFILL: Final button is ready - clicking now"),s.element.click()};try{const o=await(async(t,e,n="REQUEST")=>{const i=unsafeWindow.fetch;let o=!0;return new Promise(async(s,a)=>{unsafeWindow.fetch=async(...e)=>{const c=e[0],r=e[1]||{},l=(r.method||"GET").toUpperCase();if(!o)return i.apply(unsafeWindow,e);if("POST"!==l||"string"!=typeof c||!c.includes("/pixel/"))return i.apply(unsafeWindow,e);try{console.log("AUTOFILL: Intercepting fetch request");const e=JSON.parse(r.body),n=e.t;if(!n)throw new Error("Could not find security token 't'");const{ge:a,we:l}=t(e,n,c),h={...r,body:JSON.stringify(a)};o=!1,unsafeWindow.fetch=i,console.log("AUTOFILL: Sending modified request");const d=await i.call(unsafeWindow,l||c,h);return s(d),d}catch(t){o=!1,unsafeWindow.fetch=i,console.error(`${n}: Error during interception:`,t),a(t)}};try{await e()}catch(t){unsafeWindow.fetch=i,a(t)}})})(a,r,"AUTOFILL");return 429===o.status?(console.log(`AUTOFILL: Rate limited (429) on chunk ${i},${s}. Waiting 30s before retry...`),c(`⏰ Rate limited! Waiting 30s before retry (attempt ${n+1})...`),await new Promise(t=>setTimeout(t,3e4)),c(`🔄 Retrying pixel placement for chunk ${i},${s}...`),await u(t,e,n+1)):o}catch(t){throw t}},m=new class{constructor(t,e){this.$e=t,this.button=e,this.state={ye:!1,mode:"IDLE",xe:0},this.config={Wt:3,Te:1e4,Le:1e4,Ie:2e4},this.Oe=new Set,this.ve=null,this.Ae=!1,this.Me=!1,this.Fe=new n,this.Ce=new i(t.i)}Ue(t){return new Promise(e=>setTimeout(e,t))}ke(t,e=null){c(t),e&&(this.button.textContent=e)}Pe(t){console.log(`AUTOFILL: ${t}`),this.ke(t)}Se(t){this.state.mode=t,console.log(`AUTOFILL: State changed to ${t}`)}De(){return this.$e.i?.kt?.K.length&&this.$e.i?.kt?.gt}Ne(){const t=document.querySelector("#bm-H"),e=document.querySelector("#bm-E");if(t&&this.$e.i?.charges?.max){const n=Math.floor(this.$e.i.charges.max);t.max=n,(parseInt(t.value)||1)>n&&(t.value=n),e&&(e.textContent=`/${n}`)}}async Ee(){try{await this.$e.i.Nt()?(console.log("AUTOFILL: Fetched fresh user data"),this.Ne(),document.dispatchEvent(new CustomEvent("bmUserDataRefreshed"))):console.warn("AUTOFILL: Failed to fetch fresh user data, continuing with cached data")}catch(t){console.error("AUTOFILL: Error fetching fresh user data:",t)}}async start(){return this.state.ye?(console.log("AUTOFILL: Already running, stopping current operation"),this.stop()):this.De()?(await this.Ee(),this.state.ye=!0,this.Se("FILLING"),this.ke("🚀 Auto-fill started!","Stop Fill"),void this.Re()):this.Pe("❌ No active template available")}stop(){console.log("AUTOFILL: User requested stop"),this.state.ye=!1,this.Se("IDLE"),this.We(),this.Be(),this.ke("⏹️ Auto-fill stopped by user","Auto Fill")}Be(){try{const t=document.querySelector(".relative.px-3");if(t){const e=t.querySelector('.btn.btn-circle.btn-sm svg path[d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"]')?.closest("button");e&&(console.log("AUTOFILL: Closing paint menu during cleanup"),e.click())}}catch(t){console.log("AUTOFILL: Error during UI cleanup:",t)}}We(){this.ve?(console.log("AUTOFILL: Clearing protection interval ID:",this.ve),clearInterval(this.ve),this.ve=null,this.Ae=!1,this.Me=!1,window.bmProtectionInterval=null,console.log("AUTOFILL: Protection interval cleared and stopped"),this.ke("🛡️ Protection mode stopped")):console.log("AUTOFILL: No protection interval to clear")}async Re(){for(;this.state.ye;)try{if(this.Me){console.log("AUTOFILL: Skipping main loop cycle - protection repair in progress"),await this.Ue(5e3);continue}this.state.xe=Date.now(),await this._e()}catch(t){console.error("AUTOFILL: Cycle error:",t),this.ke(`❌ Error: ${t.message}. Retrying in 10s...`),await this.Ue(1e4)}}async _e(){console.log(`AUTOFILL: Starting cycle in ${this.state.mode} mode`);const t=await this.Ge();switch(console.log(`D_AUTOFILL: Cycle result action: ${t.action}`),t.action){case"PLACE_PIXELS":await this.ze(t.me.pe);break;case"WAIT_FOR_CHARGES":await this.Xe(t.Ye,t.He);break;case"START_PROTECTION":this.je();break;case"CONTINUE_PROTECTION":await this.Ue(this.config.Le);break;case"COMPLETE":this.complete();break}}async Ge(){await this.Ee();const t=this.$e.i?.charges;if(!t)return{action:"WAIT_FOR_CHARGES",Ye:5e3};const e=await this.Je();if(0===e.be)return window.bmProtectMode?"PROTECTING"===this.state.mode?{action:"CONTINUE_PROTECTION"}:{action:"START_PROTECTION"}:{action:"COMPLETE"};const n=e.be;if(console.log(`D_AUTOFILL: Before charge check - chunks: ${e.length}, totalPixels: ${n}, charges:`,t),this.Ce.Jt(t,n)){const e=this.Ce.qt(t,n);return console.log(`D_AUTOFILL: Waiting for charges - waitTime: ${e}ms`),{action:"WAIT_FOR_CHARGES",Ye:e,He:n}}return console.log(`D_AUTOFILL: Proceeding to place ${n} pixels in ${e.pe.length} chunks`),{action:"PLACE_PIXELS",me:e}}async Je(){await this.Ee();const t=Math.floor(this.$e.i?.charges?.count||0),e=h(this.$e.i?.extraColorsBitmap||0);if(0===e.length)return console.log("AUTOFILL: No owned colors found"),[];const n=await d(t||1,e);return r(n.be),console.log(`D_AUTOFILL: getPixelsToPlace - Charge Count: ${t||0}, Chunkgroup.length: ${n.pe?.length||0} chunks, totalPixels: ${n.be}`),n}async ze(t){this.Se("FILLING"),console.log(`AUTOFILL: Placing pixels in ${t.length} chunks`),this.ke(`🎯 Found ${t.reduce((t,e)=>t+e[1].length,0)} pixels to place`);for(let e=0;e<t.length&&this.state.ye;e++)await this.Fe.Bt(t[e],e>0);this.ke("✅ Pixel placement completed"),await this.Ue(this.config.Ie)}async Xe(t,e){this.Se("WAITING_CHARGES");let n=this.$e.i?.charges;const i=document.querySelector("#bm-H");let o=parseInt(i?.value||(n?.max?Math.floor(n.max):10));console.log(`AUTOFILL: Waiting ${(t/1e3).toFixed(1)}s for charges (${n?.count?.toFixed(2)}/${o})`),this.ke(`⏱️ Waiting ${this.qe(t/1e3)} for charges`);let s=Date.now()+t,a=0;for(;Date.now()<s&&this.state.ye;){a++;const t=parseInt(i?.value||"")||null;if(null!==t&&t!==o&&(o=t,console.log(`AUTOFILL: Detected charge limit input change -> ${o}`)),a%5==0&&(await this.Ee(),n=this.$e.i?.charges),(n?.count||0)>=o)return console.log("AUTOFILL: Charge limit reached during wait, proceeding"),void this.ke("✅ Charge limit reached - proceeding!");const c=this.Ce.qt(n||{count:0,Vt:3e4,max:o},e);c>Math.max(0,s-Date.now())&&(s=Date.now()+c,console.log(`AUTOFILL: Extending wait to ${c}ms based on updated inputs/state`));const r=Math.max(0,s-Date.now());this.ke(`⏳ Charging ${this.qe(r/1e3)} remaining`),await this.Ue(Math.min(1e3,r))}}je(){"PROTECTING"!==this.state.mode&&(this.Se("PROTECTING"),this.ke("🛡️ Protection mode active - monitoring template","Stop Fill"),this.ve=setInterval(async()=>{try{"PROTECTING"!==this.state.mode||this.Ae||(this.Ae=!0,await this.Ve(),this.Ae=!1)}catch(t){console.error("AUTOFILL: Protection check error:",t),this.ke(`❌ Protection error: ${t.message}`),this.Ae=!1}},1e4),window.bmProtectionInterval=this.ve,console.log("AUTOFILL: Protection interval started - checking every 10 seconds (ID:",this.ve,")"))}async Ve(){console.log("AUTOFILL: Checking template integrity... (protection mode:",this.state.mode,")"),this.ke("🔍 Checking template integrity...");const t=h(this.$e.i?.extraColorsBitmap||0);if(0===t.length)return console.log("AUTOFILL: No owned colors for protection check"),void this.ke("⚠️ No owned colors found for protection check");const e=await d(0,t);if(e.be>0){console.log(`AUTOFILL: Found ${e.be} pixels that need protection!`),this.ke(`🚨 Template griefed! ${e.be} pixels need fixing!`),this.Me=!0,console.log("AUTOFILL: Protection repair process started - main loop will pause");try{const n=document.querySelector("#bm-y"),i=parseInt(n?.value||"0"),o=3e4*i;if(console.log("AUTOFILL: Protection delay set to "+o),o>0){console.log(`AUTOFILL: Protection delay active - waiting ${30*i} seconds before repairing`),this.ke(`⏰ Protection delay: waiting ${30*i}s before fixing...`),await this.Ue(o),console.log("AUTOFILL: Rechecking template integrity after protection delay..."),this.ke("🔍 Rechecking template integrity after delay...");const n=await d(0,t);if(0===n.be)return console.log("AUTOFILL: Template was fixed by others during delay - no repair needed"),void this.ke("✅ Template was fixed by others during delay - no action needed");n.be<e.be?(console.log(`AUTOFILL: Partial repair by others during delay - ${n.be} pixels still need fixing (was ${e.be})`),this.ke(`🔧 Partial repair by others - ${n.be} pixels still need fixing`)):(console.log(`AUTOFILL: Damage unchanged after delay - ${n.be} pixels still need fixing`),this.ke(`🔧 Damage confirmed after delay - ${n.be} pixels need fixing`))}await this.Ee();const s=this.$e.i?.charges;if(s&&Math.floor(s.count)>0){const t=Math.min(Math.floor(s.count),e.be);console.log(`AUTOFILL: Attempting to fix ${t} pixels with ${Math.floor(s.count)} charges`),this.ke(`🔧 Fixing ${t} pixels with available charges...`);const n=await this.Je();n.be>0&&(await this.ze(n.pe),console.log("AUTOFILL: Protection repair completed"),this.ke("✅ Protection repair completed"),console.log("AUTOFILL: Waiting 10s for Ghost Pixels to clear"),this.ke("⌚ Waiting 10s for Ghost Pixels to clear"),await this.Ue(1e4))}else console.log("AUTOFILL: No charges available for immediate fixing"),this.ke("⚠️ Grief detected but no charges available for fixing")}finally{this.Me=!1,console.log("AUTOFILL: Protection repair finished - main loop can resume")}}else console.log("AUTOFILL: Template is intact"),this.ke("✅ Template protection check: All pixels intact")}complete(){console.log("AUTOFILL: Template completed - checking protection mode setting"),this.state.ye=!1,r(0),window.bmProtectMode?(console.log("AUTOFILL: Protection mode enabled - starting protection monitoring"),this.ke("🎉 Template completed! Starting protection mode..."),this.je()):(console.log("AUTOFILL: Protection mode disabled - stopping completely"),this.Se("IDLE"),this.ke("🎉 Template completed! All owned color pixels placed.","Auto Fill"))}qe(t){const e=Math.floor(t/3600),n=Math.floor(t%3600/60),i=Math.floor(t%60);return e>0?`${e}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${n}:${i.toString().padStart(2,"0")}`}}(t,e);e.Ke=m,e.onclick=async()=>{await m.start()}}).p().C({id:"bm--",textContent:"Mode: Scan",disabled:!0},(t,e)=>{const n=["Scan","Random"];let i=0;e.onclick=()=>{i=(i+1)%n.length,e.textContent=`Mode: ${n[i]}`}}).p().C({id:"bm-S",textContent:"Protect: Off",disabled:!0},(t,e)=>{let n=!1;e.onclick=()=>{const i=document.querySelector("#bm-M");i&&i.Ke&&"PROTECTING"===i.Ke.state.mode&&(console.log("AUTOFILL: Stopping active protection mode"),i.Ke.stop()),n=!n,e.textContent="Protect: "+(n?"On":"Off"),t.W("🛡️ Protection mode "+(n?"enabled":"disabled")),window.bmProtectMode=n}}).p().p().D({id:g.o,placeholder:`Status: Sleeping...\nVersion: ${p}`,readOnly:!0}).p().D({id:"bm-L",placeholder:"Auto-Fill Output:\nWaiting for auto-fill to start...",readOnly:!0}).p().D({id:"bm-K",placeholder:"Progress:\nWaiting for template analysis...",readOnly:!0}).p().T({id:"bm-1"}).T().C({id:"bm-a",className:"bm-q",innerHTML:"🎨",title:"Template Color Converter"},(t,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).p().p().I({textContent:"Made by SwingTheVine",style:"margin-top: auto;"}).p().p().p().$(document.body),setTimeout(()=>{const t=document.querySelector("#bm-M"),e=document.querySelector("#bm--"),n=document.querySelector("#bm-S");g.i?.kt?.K.length&&g.i?.kt?.gt?(t&&(t.disabled=!1),e&&(e.disabled=!1),n&&(n.disabled=!1)):(t&&(t.disabled=!0),e&&(e.disabled=!0),n&&(n.disabled=!0));const i=document.querySelector("#bm-H"),o=document.querySelector("#bm-E");if(i&&o&&g.i?.charges?.max){const t=Math.floor(g.i.charges.max<=10?g.i.charges.max:10);i.max=t,i.value=t,o.textContent=`/${t}`}initializeColorOwnershipDebugger(g)},1e3)}(),g.N("#bm-n","#bm-i"),$.Et(g),new MutationObserver((t,e)=>{const n=document.querySelector("#color-1");if(!n)return;let i=document.querySelector("#bm-g");if(!i){i=document.createElement("button"),i.id="bm-g",i.textContent="Move ↑",i.className="btn btn-soft",i.onclick=function(){const t=this.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;t.parentNode.className=t.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),t.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",t.style.borderTopRightRadius=e?"0px":"var(--radius-box)",t.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",t.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const t=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");t.parentNode?.appendChild(i)}}).observe(document.body,{childList:!0,subtree:!0}),function(...t){(0,console.log)(...t)}(`%c${m}%c (${p}) userscript has loaded!`,"color: cornflowerblue;","")})();